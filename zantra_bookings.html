<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zantra Bookings</title>
    <style>
      :root {
        color-scheme: light;
        --brand-primary: #4c1d95;
        --brand-accent: #7c3aed;
        --brand-surface: #f5f3ff;
        --brand-text: #1f2937;
        --brand-success: #047857;
        --brand-warning: #f59e0b;
        --brand-danger: #dc2626;
        --surface-border: #e5e7eb;
        --surface-muted: #f3f4f6;
        --text-muted: #4b5563;
        --text-soft: #6b7280;
        --spacing-1: 0.5rem;
        --spacing-2: 1rem;
        --spacing-3: 1.5rem;
        --spacing-4: 2rem;
        --card-radius: 8px;
        --card-shadow: 0 2px 8px rgba(15, 23, 42, 0.05);
        --card-padding: 18px;
        --button-font-size: 0.95rem;
        --button-min-height: 38px;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Arial", "Helvetica Neue", Helvetica, sans-serif;
        font-size: 16px;
        line-height: 1.5;
        background: #f9fafb;
        color: var(--brand-text);
      }
      h1,
      h2,
      h3,
      h4,
      h5 {
        margin: 0;
        font-weight: 600;
        line-height: 1.35;
      }
      h1 {
        font-size: 1.35rem;
        font-weight: 600;
      }
      h2 {
        font-size: 1.125rem;
      }
      h3 {
        font-size: 1rem;
        font-weight: 500;
      }
      a {
        color: var(--brand-primary);
      }
      button,
      input,
      select,
      textarea {
        font: inherit;
      }
      .hidden {
        display: none !important;
      }
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      .flex {
        display: flex;
      }
      .grid {
        display: grid;
      }
      .flex-col {
        flex-direction: column;
      }
      .flex-wrap {
        flex-wrap: wrap;
      }
      .items-center {
        align-items: center;
      }
      .items-start {
        align-items: flex-start;
      }
      .justify-between {
        justify-content: space-between;
      }
      .justify-end {
        justify-content: flex-end;
      }
      .gap-2 {
        gap: 0.5rem;
      }
      .gap-3 {
        gap: 1rem;
      }
      .gap-4 {
        gap: 1.5rem;
      }
      .gap-6 {
        gap: 2rem;
      }
      .gap-8 {
        gap: 3rem;
      }
      .p-2 {
        padding: 0.5rem;
      }
      .p-3 {
        padding: 1rem;
      }
      .p-4 {
        padding: 1.5rem;
      }
      .p-6 {
        padding: 2rem;
      }
      .p-8 {
        padding: 3rem;
      }
      .px-3 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .px-4 {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
      .py-2 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .py-3 {
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
      .py-4 {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
      }
      .py-6 {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
      }
      .pt-4 {
        padding-top: 1.5rem;
      }
      .mt-2 {
        margin-top: 0.5rem;
      }
      .mt-3 {
        margin-top: 1rem;
      }
      .mt-4 {
        margin-top: 1.5rem;
      }
      .mt-6 {
        margin-top: 2rem;
      }
      .mt-8 {
        margin-top: 3rem;
      }
      .mb-2 {
        margin-bottom: 0.5rem;
      }
      .mb-3 {
        margin-bottom: 1rem;
      }
      .mb-4 {
        margin-bottom: 1.5rem;
      }
      .mb-6 {
        margin-bottom: 2rem;
      }
      .ml-auto {
        margin-left: auto;
      }
      .rounded {
        border-radius: 0.5rem;
      }
      .rounded-md {
        border-radius: 0.75rem;
      }
      .rounded-full {
        border-radius: 9999px;
      }
      .shadow {
        box-shadow: var(--card-shadow);
      }
      .shadow-sm {
        box-shadow: var(--card-shadow);
      }
      .border {
        border: 1px solid rgba(79, 70, 229, 0.15);
      }
      .border-dashed {
        border-style: dashed;
      }
      .border-0 {
        border: none;
      }
      .border-b {
        border-bottom: 1px solid rgba(79, 70, 229, 0.12);
      }
      .text-center {
        text-align: center;
      }
      .text-right {
        text-align: right;
      }
      .text-sm {
        font-size: 0.875rem;
      }
      .text-xs {
        font-size: 0.75rem;
      }
      .text-lg {
        font-size: 1.125rem;
      }
      .text-xl {
        font-size: 1.2rem;
      }
      .text-2xl {
        font-size: 1.35rem;
      }
      .text-muted {
        color: var(--text-soft);
      }
      .font-semibold {
        font-weight: 600;
      }
      .font-medium {
        font-weight: 500;
      }
      .uppercase {
        text-transform: uppercase;
      }
      .tracking-wide {
        letter-spacing: 0.08em;
      }
      .w-full {
        width: 100%;
      }
      .w-1\/2 {
        width: 50%;
      }
      .w-1\/3 {
        width: 33.333%;
      }
      .w-2\/3 {
        width: 66.666%;
      }
      .max-w-6xl {
        max-width: 72rem;
      }
      .max-w-4xl {
        max-width: 56rem;
      }
      .mx-auto {
        margin-left: auto;
        margin-right: auto;
      }
      .bg-surface {
        background: var(--brand-surface);
      }
      .bg-white {
        background: #ffffff;
      }
      .bg-primary {
        background: var(--brand-primary);
      }
      .bg-primary-soft {
        background: rgba(76, 29, 149, 0.08);
      }
      .bg-success-soft {
        background: rgba(4, 120, 87, 0.1);
      }
      .bg-danger-soft {
        background: rgba(220, 38, 38, 0.1);
      }
      .bg-warning-soft {
        background: rgba(245, 158, 11, 0.1);
      }
      .text-primary {
        color: var(--brand-primary);
      }
      .text-success {
        color: var(--brand-success);
      }
      .text-danger {
        color: var(--brand-danger);
      }
      .text-warning {
        color: var(--brand-warning);
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-height: var(--button-min-height);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: var(--button-font-size);
        line-height: 1.3;
        border: 1px solid transparent;
        cursor: pointer;
        transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
      }
      .btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(76, 29, 149, 0.18);
      }
      .btn:hover {
        transform: translateY(-1px);
      }
      .btn-primary {
        background: var(--brand-primary);
        color: #fff;
        border-color: var(--brand-primary);
      }
      .btn-primary:hover,
      .btn-primary:focus-visible {
        background: #3a1680;
        border-color: #3a1680;
      }
      .btn-secondary {
        background: #6b7280;
        color: #fff;
        border-color: #6b7280;
      }
      .btn-secondary:hover,
      .btn-secondary:focus-visible {
        background: #4b5563;
        border-color: #4b5563;
      }
      .btn-outline {
        background: #fff;
        border-color: rgba(76, 29, 149, 0.4);
        color: var(--brand-primary);
      }
      .btn-outline:hover,
      .btn-outline:focus-visible {
        background: rgba(76, 29, 149, 0.08);
        border-color: var(--brand-primary);
        color: var(--brand-primary);
      }
      .btn-danger {
        background: var(--brand-danger);
        color: #fff;
        border-color: var(--brand-danger);
      }
      .btn-danger:hover,
      .btn-danger:focus-visible {
        background: #b91c1c;
        border-color: #b91c1c;
      }
      .input {
        width: 100%;
        min-height: 50px;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        background: #fff;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      .input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 2px rgba(76, 29, 149, 0.12);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: #fff;
      }
      th,
      td {
        padding: 0.75rem 0.85rem;
        border-right: 1px solid rgba(148, 163, 184, 0.25);
        border-bottom: 1px solid rgba(148, 163, 184, 0.25);
        text-align: left;
        font-weight: 400;
      }
      th {
        background: #f8fafc;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.75rem;
        border-bottom: 2px solid rgba(76, 29, 149, 0.35);
      }
      th:last-child,
      td:last-child {
        border-right: none;
      }
      tbody tr:nth-child(even) {
        background: #f9fafb;
      }
      tbody tr:hover {
        background: rgba(124, 58, 237, 0.08);
      }
      tbody tr:last-child td {
        border-bottom: none;
      }
      @media (max-width: 960px) {
        .grid-cols-2 {
          grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        .responsive-table {
          display: block;
          overflow-x: auto;
        }
        .w-1\/2,
        .w-2\/3,
        .w-1\/3 {
          width: 100%;
        }
      }
      @media (min-width: 961px) {
        .grid-cols-2 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      header {
        background: #2a1660;
        color: #f8fafc;
        padding: 1.5rem 0;
        border-bottom: none;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.18);
      }
      header .section-subtext {
        color: rgba(226, 232, 240, 0.85);
      }
      nav {
        border-bottom: none;
        padding: 0.5rem;
        background: rgba(15, 15, 35, 0.45);
        border-radius: 0.75rem;
      }
      nav button {
        background: transparent;
        border: none;
        padding: 0.35rem 1rem;
        color: rgba(255, 255, 255, 0.72);
        cursor: pointer;
        font-weight: 500;
        font-size: 0.95rem;
        border-bottom: 3px solid transparent;
        border-radius: 0;
        min-height: var(--button-min-height);
        transition: color 0.2s ease, border-color 0.2s ease;
      }
      nav button:hover,
      nav button:focus-visible {
        color: #fff;
        outline: none;
      }
      nav button:focus-visible {
        box-shadow: inset 0 -3px 0 0 rgba(255, 255, 255, 0.35);
      }
      nav button.active {
        color: #fff;
        border-bottom-color: rgba(255, 255, 255, 0.9);
      }
      .card,
      .timeline-card,
      .nested-card,
      .mini-card,
      .kpi-card {
        background: #fff;
        border-radius: var(--card-radius);
        border: 1px solid rgba(148, 163, 184, 0.22);
        box-shadow: var(--card-shadow);
      }
      .card {
        padding: var(--card-padding);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 999px;
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .badge-success {
        background: rgba(4, 120, 87, 0.12);
        color: var(--brand-success);
      }
      .badge-warning {
        background: rgba(245, 158, 11, 0.15);
        color: var(--brand-warning);
      }
      .badge-danger {
        background: rgba(220, 38, 38, 0.15);
        color: var(--brand-danger);
      }
      .badge-info {
        background: rgba(76, 29, 149, 0.12);
        color: var(--brand-primary);
      }
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.72);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        padding: 1rem;
      }
      .modal-card {
        width: min(520px, 100%);
        background: #fff;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: 0 28px 56px rgba(15, 23, 42, 0.24);
        position: relative;
        overflow: hidden;
      }
      .modal-header {
        background: var(--brand-primary);
        color: #fff;
        padding: 1.5rem 2rem;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
      }
      .modal-body {
        padding: 2rem;
        background: #fff;
      }
      .modal-body p {
        margin: 0.5rem 0 1.5rem;
        color: #4b5563;
      }
      .toast-container {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 60;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .toast {
        min-width: 240px;
        background: #fff;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
        border-left: 4px solid var(--brand-primary);
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }
      .toast.success {
        border-color: var(--brand-success);
      }
      .toast.error {
        border-color: var(--brand-danger);
      }
      .toast button {
        background: transparent;
        border: none;
        color: var(--text-soft);
        cursor: pointer;
        font-size: 1rem;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 0.5rem;
      }
      .status-dot.confirmed {
        background: var(--brand-success);
      }
      .status-dot.pending {
        background: var(--brand-warning);
      }
      .status-dot.cancelled {
        background: var(--brand-danger);
      }
      .status-dot.completed {
        background: var(--brand-primary);
      }
      .chip {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 500;
        background: rgba(255, 255, 255, 0.18);
        color: #f8fafc;
      }
      .link {
        color: var(--brand-primary);
        text-decoration: none;
        font-weight: 500;
      }
      .link:hover {
        text-decoration: underline;
      }
      .list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .list-item {
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: var(--card-radius);
        padding: var(--card-padding);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: #fff;
        box-shadow: var(--card-shadow);
      }
      .badge-light {
        background: var(--surface-muted);
        color: var(--text-muted);
        border-radius: 999px;
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .divider {
        height: 1px;
        background: var(--surface-border);
        margin: 1.5rem 0;
      }
      .textarea {
        width: 100%;
        min-height: 140px;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        resize: vertical;
      }
      .textarea:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 2px rgba(76, 29, 149, 0.12);
      }
      .tab-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.25rem;
      }
      .section-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        position: relative;
        padding-bottom: 0.5rem;
        font-family: 'Arial', 'Helvetica Neue', Helvetica, sans-serif;
      }
      .section-title::after {
        content: "";
        position: absolute;
        left: 0;
        bottom: 0;
        width: 3rem;
        height: 3px;
        background: var(--brand-primary);
        border-radius: 999px;
      }
      .inline-form {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
      }
      .form-grid {
        gap: 1rem;
      }
      .form-grid > * {
        min-width: 0;
      }
      .form-grid > div {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .form-grid .action-bar {
        margin-top: 0.5rem;
      }
      .inline-form .input-group {
        flex: 1;
        min-width: 160px;
      }
      .input-label {
        display: block;
        font-size: 1rem;
        font-weight: 700;
        text-transform: none;
        letter-spacing: normal;
        color: var(--brand-text);
        margin-bottom: 0.5rem;
      }
      .form-error {
        margin-top: 0.5rem;
        color: var(--brand-danger);
        font-size: 0.9rem;
      }
      .section-subtext {
        color: var(--text-soft);
        font-size: 0.95rem;
      }
      .header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
      }
      .avatar {
        width: 48px;
        height: 48px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.16);
        border: 1px solid rgba(255, 255, 255, 0.32);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        color: #f8fafc;
      }
      .tag {
        padding: 0.5rem 1rem;
        border-radius: 999px;
        background: rgba(76, 29, 149, 0.08);
        color: var(--brand-primary);
        font-size: 0.75rem;
        font-weight: 500;
      }
      .pill-toggle {
        display: inline-flex;
        background: rgba(76, 29, 149, 0.08);
        border-radius: 999px;
        padding: 0.5rem;
      }
      .pill-toggle button {
        border-radius: 999px;
        border: none;
        padding: 0.5rem 1rem;
        background: transparent;
        font-weight: 500;
        color: var(--brand-primary);
        cursor: pointer;
      }
      .pill-toggle button.active {
        background: #fff;
        box-shadow: 0 4px 12px rgba(76, 29, 149, 0.12);
      }
      .lock-screen {
        text-align: center;
      }
      .lock-icon {
        width: 80px;
        height: 80px;
        border-radius: 24px;
        background: var(--surface-muted);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        color: var(--brand-primary);
        font-size: 2.5rem;
      }
      .license-info {
        background: rgba(76, 29, 149, 0.07);
        border-radius: var(--card-radius);
        padding: var(--card-padding);
        margin-bottom: 1rem;
        color: #4338ca;
        font-weight: 500;
      }
      .danger-zone {
        border: 1px solid rgba(220, 38, 38, 0.35);
        background: rgba(220, 38, 38, 0.08);
        border-radius: var(--card-radius);
        padding: var(--card-padding);
      }
      .danger-zone h3 {
        color: var(--brand-danger);
        margin-bottom: 0.5rem;
      }
      .badge-square {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        background: var(--surface-muted);
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-muted);
      }
      .timeline {
        border-left: 2px solid rgba(148, 163, 184, 0.35);
        margin-left: 0.5rem;
        padding-left: 1.5rem;
      }
      .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
      }
      .timeline-item::before {
        content: "";
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--brand-accent);
        left: -1.75rem;
        top: 0.65rem;
      }
      .timeline-card,
      .nested-card {
        padding: var(--card-padding);
      }
      .mini-card {
        padding: var(--card-padding);
        display: grid;
        grid-auto-rows: auto;
        align-content: space-between;
        gap: 0.5rem;
        min-height: 120px;
      }
      .overflow-auto {
        overflow: auto;
      }
      .text-balance {
        text-wrap: balance;
      }
      .sticky-footer {
        margin-top: 2rem;
        padding: 1.5rem 0;
        text-align: center;
        font-size: 0.95rem;
        color: var(--text-soft);
        border-top: 1px solid var(--surface-border);
      }
      .action-bar {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .action-bar .btn {
        flex: 0 0 auto;
        min-width: 128px;
      }
      .action-bar.compact .btn {
        flex: 0 0 auto;
      }
      .empty-state-card {
        background: #f8fafc;
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: var(--card-radius);
        padding: var(--card-padding);
        text-align: center;
        color: var(--text-soft);
        font-weight: 500;
        display: grid;
        place-items: center;
        gap: 0.5rem;
        min-height: 140px;
      }
      .empty-state-card::before {
        content: attr(data-icon);
        font-size: 1.75rem;
        line-height: 1;
      }
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.25rem;
        grid-auto-rows: minmax(140px, 1fr);
      }
      .chart-panel {
        position: relative;
        min-height: 320px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .chart-panel canvas {
        width: 100%;
        height: 320px;
      }
      .chart-panel .empty-state-card {
        position: absolute;
        inset: 0;
      }
      .kpi-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.25rem;
        grid-auto-rows: minmax(140px, 1fr);
      }
      .kpi-card {
        padding: var(--card-padding);
        display: grid;
        gap: 0.5rem;
        min-height: 160px;
        align-content: center;
      }
    </style>
  </head>
  <body>
    <div class="toast-container" id="toastContainer" role="status" aria-live="polite"></div>
    <div id="licenseModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <div class="modal-card">
        <div class="modal-header">
          <h2>License Activation Required</h2>
        </div>
        <div class="modal-body lock-screen">
          <div class="lock-icon" aria-hidden="true">ðŸ”’</div>
          <p class="text-balance">
            Zantra Bookings is protected by a 12-month offline license. Enter your activation
            code to unlock the console.
          </p>
          <div class="license-info" id="licenseInfo"></div>
          <form id="licenseForm" class="flex flex-col gap-3">
            <label class="input-label" for="licenseCode">Activation Code</label>
            <input
              id="licenseCode"
              class="input"
              type="password"
              autocomplete="off"
              maxlength="32"
              required
              placeholder="Enter unlock code"
            />
            <button type="submit" class="btn btn-primary">Unlock Console</button>
          </form>
        </div>
      </div>
    </div>

    <div id="accountSetupModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <div class="modal-card">
        <div class="modal-header">
          <h2>Create Your Zantra Account</h2>
        </div>
        <div class="modal-body">
          <p>Set a secure username and password. Credentials are stored locally using SHA-256.</p>
          <form id="accountSetupForm" class="flex flex-col gap-3" autocomplete="off">
            <div>
              <label class="input-label" for="setupUsername">Username</label>
              <input id="setupUsername" class="input" type="text" required minlength="3" maxlength="32" />
            </div>
            <div>
              <label class="input-label" for="setupPassword">Password</label>
              <input
                id="setupPassword"
                class="input"
                type="password"
                required
                minlength="8"
                maxlength="64"
              />
            </div>
            <div>
              <label class="input-label" for="setupPasswordConfirm">Confirm Password</label>
              <input
                id="setupPasswordConfirm"
                class="input"
                type="password"
                required
                minlength="8"
                maxlength="64"
              />
            </div>
            <div class="action-bar">
              <button type="submit" class="btn btn-primary">Create Account</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="pinSetupModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <div class="modal-card">
        <div class="modal-header">
          <h2>Set an Optional Quick PIN</h2>
        </div>
        <div class="modal-body">
          <p>Use a 4-digit PIN for faster access. You can always sign in with your password.</p>
          <form id="pinSetupForm" class="flex flex-col gap-3" autocomplete="off">
            <div>
              <label class="input-label" for="setupPin">4-Digit PIN</label>
              <input
                id="setupPin"
                class="input"
                type="password"
                inputmode="numeric"
                pattern="\d{4}"
                maxlength="4"
                minlength="4"
                required
              />
            </div>
            <div class="action-bar">
              <button type="submit" class="btn btn-primary">Save PIN</button>
              <button type="button" id="skipPinButton" class="btn btn-outline">Skip</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="loginModal" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <div class="modal-card">
        <div class="modal-header">
          <h2>Welcome Back</h2>
        </div>
        <div class="modal-body">
          <p>Choose your preferred authentication method to access Zantra Bookings.</p>
          <div class="pill-toggle" role="tablist" aria-label="Authentication method">
            <button id="passwordTab" class="active" role="tab" aria-selected="true">Password</button>
            <button id="pinTab" role="tab" aria-selected="false">PIN</button>
          </div>
          <form id="loginForm" class="flex flex-col gap-3 mt-3" autocomplete="off">
            <div>
              <label class="input-label" for="loginUsername">Username</label>
              <input id="loginUsername" class="input" type="text" required autocomplete="username" />
            </div>
            <div>
              <label class="input-label" for="loginPassword">Password</label>
              <input
                id="loginPassword"
                class="input"
                type="password"
                required
                autocomplete="current-password"
              />
            </div>
            <div class="action-bar">
              <button type="submit" class="btn btn-primary">Sign In</button>
            </div>
            <p class="text-sm text-muted">Locked after 5 failed attempts for 5 minutes.</p>
          </form>
          <form id="pinLoginForm" class="flex flex-col gap-3 mt-3 hidden" autocomplete="off">
            <div>
              <label class="input-label" for="loginPin">4-Digit PIN</label>
              <input
                id="loginPin"
                class="input"
                type="password"
                inputmode="numeric"
                pattern="\d{4}"
                maxlength="4"
                minlength="4"
                required
              />
            </div>
            <div class="action-bar">
              <button type="submit" class="btn btn-primary">Unlock with PIN</button>
            </div>
            <p class="text-sm text-muted">Forgot PIN? Use the password tab instead.</p>
          </form>
        </div>
      </div>
    </div>

    <header>
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <span class="chip">Zantra Suite</span>
            <h1 class="text-2xl">Zantra Bookings Console</h1>
            <p class="section-subtext" id="businessTagline">
              Manage bookings, invoices, and insights offline-first.
            </p>
          </div>
          <div class="header-actions">
            <div class="avatar" id="userAvatar" aria-hidden="true">ZB</div>
            <div>
              <p class="text-sm" id="activeUserLabel">Offline Mode</p>
              <button id="logoutButton" class="btn btn-secondary">Logout</button>
            </div>
          </div>
        </div>
        <nav class="flex gap-2 mt-4" role="tablist" aria-label="Primary">
          <button class="active" data-tab="dashboard" role="tab" aria-selected="true">Dashboard</button>
          <button data-tab="bookings" role="tab" aria-selected="false">Bookings</button>
          <button data-tab="billing" role="tab" aria-selected="false">Payments &amp; Invoices</button>
          <button data-tab="reports" role="tab" aria-selected="false">Reports</button>
          <button data-tab="settings" role="tab" aria-selected="false">Settings</button>
        </nav>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6">
      <section id="dashboard" class="tab-content active">
        <div class="tab-grid">
          <div class="card">
            <h2 class="section-title">Today at a glance</h2>
            <p class="section-subtext">Key operational metrics for your studio.</p>
            <div class="metrics-grid mt-4">
              <div class="mini-card">
                <p class="text-sm text-muted">Upcoming Bookings</p>
                <p class="text-2xl font-semibold" id="metricUpcoming">0</p>
              </div>
              <div class="mini-card">
                <p class="text-sm text-muted">Pending Invoices</p>
                <p class="text-2xl font-semibold" id="metricPendingInvoices">0</p>
              </div>
              <div class="mini-card">
                <p class="text-sm text-muted">Collected this Month</p>
                <p class="text-2xl font-semibold" id="metricCollected">$0.00</p>
              </div>
              <div class="mini-card">
                <p class="text-sm text-muted">Average Payment Time</p>
                <p class="text-2xl font-semibold" id="metricAvgPayment">0 days</p>
              </div>
            </div>
          </div>
          <div class="card">
            <h2 class="section-title">Recent Activity</h2>
            <p class="section-subtext">Latest bookings, payments, and status changes.</p>
            <div class="timeline mt-4" id="activityTimeline" aria-live="polite" role="list"></div>
          </div>
        </div>
      </section>

      <section id="bookings" class="tab-content">
        <div class="card">
          <h2 class="section-title">Add Booking</h2>
          <p class="section-subtext">Capture bookings with client details and session status.</p>
          <form id="bookingForm" class="grid grid-cols-2 form-grid mt-4">
            <div>
              <label class="input-label" for="bookingDate">Date</label>
              <input id="bookingDate" class="input" type="date" required />
            </div>
            <div>
              <label class="input-label" for="bookingTime">Time</label>
              <input id="bookingTime" class="input" type="time" required />
            </div>
            <div>
              <label class="input-label" for="bookingClient">Client</label>
              <input id="bookingClient" class="input" type="text" required maxlength="80" />
            </div>
            <div>
              <label class="input-label" for="bookingStatus">Status</label>
              <select id="bookingStatus" class="input" required>
                <option value="confirmed">Confirmed</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="action-bar">
              <button type="submit" class="btn btn-primary">Save Booking</button>
              <button type="reset" class="btn btn-outline">Reset</button>
            </div>
          </form>
        </div>
        <div class="card mt-6">
          <div class="flex items-center justify-between">
            <h2 class="section-title">Booking Ledger</h2>
            <span class="badge-light" id="bookingCountLabel">0 Records</span>
          </div>
          <div class="responsive-table mt-4">
            <table aria-label="Bookings table">
              <thead>
                <tr>
                  <th scope="col">Date</th>
                  <th scope="col">Time</th>
                  <th scope="col">Client</th>
                  <th scope="col">Status</th>
                  <th scope="col" class="text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="bookingTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="billing" class="tab-content">
        <div class="card">
          <h2 class="section-title">Invoice Builder</h2>
          <p class="section-subtext">Generate invoices and track payment activity.</p>
          <form id="invoiceForm" class="grid grid-cols-2 form-grid mt-4">
            <input type="hidden" id="invoiceId" />
            <div>
              <label class="input-label" for="invoiceClient">Client</label>
              <input id="invoiceClient" class="input" type="text" required maxlength="80" />
            </div>
            <div>
              <label class="input-label" for="invoiceAmount">Amount</label>
              <input
                id="invoiceAmount"
                class="input"
                type="number"
                min="0"
                step="0.01"
                required
              />
            </div>
            <div>
              <label class="input-label" for="invoiceDueDate">Due Date</label>
              <input id="invoiceDueDate" class="input" type="date" required />
            </div>
            <div>
              <label class="input-label" for="invoiceStatus">Status</label>
              <select id="invoiceStatus" class="input" required>
                <option value="draft">Draft</option>
                <option value="sent">Sent</option>
                <option value="paid">Paid</option>
                <option value="overdue">Overdue</option>
              </select>
            </div>
            <div class="action-bar">
              <button type="submit" class="btn btn-primary">Save Invoice</button>
              <button type="reset" id="invoiceReset" class="btn btn-outline">Reset</button>
            </div>
            <div class="grid grid-cols-1 gap-3 w-full">
              <label class="input-label" for="invoiceNotes">Notes</label>
              <textarea id="invoiceNotes" class="textarea" placeholder="Project scope, deliverables, etc."></textarea>
            </div>
          </form>
        </div>
        <div class="card mt-6">
          <div class="flex items-center justify-between">
            <h2 class="section-title">Invoices &amp; Payments</h2>
            <span class="badge-light" id="invoiceCountLabel">0 Invoices</span>
          </div>
          <div id="invoiceList" class="list mt-4" aria-live="polite"></div>
        </div>
      </section>

      <section id="reports" class="tab-content">
        <div class="tab-grid">
          <div class="card">
            <h2 class="section-title">Monthly Revenue</h2>
            <p class="section-subtext">Track paid amounts over the last 12 months.</p>
            <div class="chart-panel">
              <canvas id="revenueChart" height="320" role="img" aria-label="Monthly revenue chart"></canvas>
              <div id="revenueEmptyState" class="empty-state-card hidden" data-icon="ðŸ’³">
                No payments recorded yet.
              </div>
            </div>
          </div>
          <div class="card">
            <h2 class="section-title">Monthly Bookings</h2>
            <p class="section-subtext">Booking volume across the last 12 months.</p>
            <div class="chart-panel">
              <canvas id="bookingsChart" height="320" role="img" aria-label="Monthly bookings chart"></canvas>
              <div id="bookingsEmptyState" class="empty-state-card hidden" data-icon="ðŸ—‚">
                No bookings captured yet.
              </div>
            </div>
          </div>
        </div>
        <div class="card mt-6">
          <h2 class="section-title">Outstanding Invoices</h2>
          <p class="section-subtext">Monitor unpaid invoices and expected revenue.</p>
          <div class="kpi-panel mt-4">
            <div class="kpi-card">
              <p class="text-sm text-muted">Outstanding Count</p>
              <p class="text-2xl font-semibold" id="outstandingCount">0</p>
            </div>
            <div class="kpi-card">
              <p class="text-sm text-muted">Outstanding Amount</p>
              <p class="text-2xl font-semibold" id="outstandingAmount">$0.00</p>
            </div>
          </div>
        </div>
      </section>

      <section id="settings" class="tab-content">
        <div class="card">
          <h2 class="section-title">Branding</h2>
          <p class="section-subtext">Customize outgoing invoices and in-app identity.</p>
          <form id="brandingForm" class="grid grid-cols-2 form-grid mt-4">
            <div>
              <label class="input-label" for="businessName">Business Name</label>
              <input id="businessName" class="input" type="text" maxlength="80" />
            </div>
            <div>
              <label class="input-label" for="businessEmail">Email</label>
              <input id="businessEmail" class="input" type="email" maxlength="120" />
            </div>
            <div>
              <label class="input-label" for="businessPhone">Phone</label>
              <input id="businessPhone" class="input" type="tel" maxlength="40" />
            </div>
            <div>
              <label class="input-label" for="businessAddress">Address</label>
              <textarea id="businessAddress" class="textarea" rows="3"></textarea>
            </div>
            <div>
              <label class="input-label" for="brandColor">Brand Accent</label>
              <input id="brandColor" class="input" type="color" />
            </div>
            <div class="action-bar">
              <button type="submit" class="btn btn-primary">Save Branding</button>
              <button type="button" id="resetBranding" class="btn btn-outline">Reset Theme</button>
            </div>
          </form>
        </div>
        <div class="card mt-6">
          <h2 class="section-title">Security</h2>
          <p class="section-subtext">Update login credentials or reset your PIN.</p>
          <div class="grid grid-cols-2 gap-4 mt-4">
            <form id="updateCredentialsForm" class="flex flex-col gap-3">
              <h3 class="text-lg font-semibold">Update Username &amp; Password</h3>
              <div>
                <label class="input-label" for="updateUsername">New Username</label>
                <input id="updateUsername" class="input" type="text" minlength="3" maxlength="32" required />
              </div>
              <div>
                <label class="input-label" for="updatePassword">New Password</label>
                <input id="updatePassword" class="input" type="password" minlength="8" maxlength="64" required />
              </div>
              <div>
                <label class="input-label" for="updatePasswordConfirm">Confirm Password</label>
                <input
                  id="updatePasswordConfirm"
                  class="input"
                  type="password"
                  minlength="8"
                  maxlength="64"
                  required
                />
              </div>
              <div class="action-bar">
                <button type="submit" class="btn btn-primary">Update Credentials</button>
              </div>
            </form>
            <form id="updatePinForm" class="flex flex-col gap-3">
              <h3 class="text-lg font-semibold">Reset Quick PIN</h3>
              <div>
                <label class="input-label" for="updatePin">New 4-Digit PIN</label>
                <input
                  id="updatePin"
                  class="input"
                  type="password"
                  inputmode="numeric"
                  pattern="\d{4}"
                  maxlength="4"
                  minlength="4"
                  required
                />
              </div>
              <div class="action-bar">
                <button type="submit" class="btn btn-secondary">Update PIN</button>
              </div>
            </form>
          </div>
          <div class="divider"></div>
          <div class="danger-zone">
            <h3>Danger Zone</h3>
            <p class="section-subtext">
              Clearing credentials resets the license activation, username, password, and PIN.
            </p>
            <div class="action-bar">
              <button id="clearCredentials" class="btn btn-danger">Clear Credentials</button>
            </div>
          </div>
        </div>
        <div class="card mt-6">
          <h2 class="section-title">Data Management</h2>
          <p class="section-subtext">Export or import your Zantra Bookings data as JSON.</p>
          <div class="action-bar mt-4">
            <button id="exportData" class="btn btn-primary">Export Data</button>
            <label class="btn btn-outline" for="importFile">Import JSON</label>
            <input id="importFile" type="file" accept="application/json" class="hidden" />
          </div>
        </div>
        <div class="card mt-6">
          <h2 class="section-title">Audit Trail</h2>
          <p class="section-subtext">Review the latest activity synced across the workspace.</p>
          <div id="auditTrailList" class="list audit-list mt-4" aria-live="polite" role="list"></div>
        </div>
        <p class="sticky-footer">Zantra Bookings operates entirely offline. Remember to back up regularly.</p>
      </section>
    </main>
    <script>
      class Chart {
        constructor(ctx, config) {
          this.ctx = ctx;
          this.data = config.data || { labels: [], datasets: [] };
          this.options = config.options || {};
          this.type = config.type || 'bar';
          this.render();
        }
        destroy() {
          const canvas = this.ctx.canvas;
          this.ctx.clearRect(0, 0, canvas.width, canvas.height);
          canvas.removeAttribute('data-chart-ready');
        }
        update(config) {
          if (config) {
            if (config.data) this.data = config.data;
            if (config.options) this.options = config.options;
          }
          this.render();
        }
        render() {
          const canvas = this.ctx.canvas;
          const context = this.ctx;
          const pixelRatio = window.devicePixelRatio || 1;
          const width = canvas.clientWidth || canvas.width;
          const height = canvas.clientHeight || canvas.height;
          if (!width || !height) {
            return;
          }
          if (!canvas.hasAttribute('data-chart-ready')) {
            canvas.width = width * pixelRatio;
            canvas.height = height * pixelRatio;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            canvas.setAttribute('data-chart-ready', 'true');
            context.scale(pixelRatio, pixelRatio);
          }
          context.clearRect(0, 0, width, height);
          const labels = this.data.labels || [];
          const datasets = this.data.datasets || [];
          if (!labels.length || !datasets.length) {
            return;
          }
          const padding = 48;
          const chartWidth = width - padding * 2;
          const chartHeight = height - padding * 2;
          const dataset = datasets[0] || { data: [] };
          const values = dataset.data || [];
          if (!values.length) {
            return;
          }
          const maxValue = Math.max(...values, 1);
          const barSpace = chartWidth / values.length;
          const barWidth = barSpace * 0.6;
          const axisColor = 'rgba(148, 163, 184, 0.35)';
          const gridColor = 'rgba(148, 163, 184, 0.18)';
          context.strokeStyle = axisColor;
          context.lineWidth = 1;
          context.beginPath();
          context.moveTo(padding, padding);
          context.lineTo(padding, padding + chartHeight);
          context.lineTo(padding + chartWidth, padding + chartHeight);
          context.stroke();
          const gradient = context.createLinearGradient(0, padding, 0, padding + chartHeight);
          const stops = Array.isArray(dataset.gradientStops) && dataset.gradientStops.length
            ? dataset.gradientStops
            : [
                { offset: 0, color: 'rgba(76,29,149,0.85)' },
                { offset: 1, color: 'rgba(124,58,237,0.6)' },
              ];
          stops.forEach((stop) => gradient.addColorStop(stop.offset, stop.color));
          const formatValue =
            typeof dataset.formatValue === 'function'
              ? dataset.formatValue
              : (value) => value;
          const formatAxis =
            typeof dataset.formatAxis === 'function'
              ? dataset.formatAxis
              : (value) => value;
          const tickCount = 4;
          context.strokeStyle = axisColor;
          context.fillStyle = '#94a3b8';
          context.font = '11px Arial';
          context.textAlign = 'right';
          context.textBaseline = 'middle';
          for (let i = 0; i <= tickCount; i += 1) {
            const value = (maxValue / tickCount) * i;
            const y = padding + chartHeight - chartHeight * (i / tickCount);
            context.beginPath();
            context.moveTo(padding - 6, y);
            context.lineTo(padding, y);
            context.stroke();
            if (i > 0 && i < tickCount) {
              context.strokeStyle = gridColor;
              context.beginPath();
              context.moveTo(padding, y);
              context.lineTo(padding + chartWidth, y);
              context.stroke();
              context.strokeStyle = axisColor;
            }
            const axisLabel = formatAxis(value);
            context.fillText(axisLabel, padding - 12, y);
          }
          context.textAlign = 'center';
          context.textBaseline = 'alphabetic';
          values.forEach((value, index) => {
            const ratio = value / maxValue;
            const barHeight = Math.max(ratio * (chartHeight - 24), 4);
            const x = padding + index * barSpace + (barSpace - barWidth) / 2;
            const y = padding + chartHeight - barHeight;
            context.fillStyle = gradient;
            context.beginPath();
            context.roundRect(x, y, barWidth, barHeight, 8);
            context.fill();
            context.fillStyle = '#94a3b8';
            context.font = '11px Arial';
            context.fillText(labels[index], x + barWidth / 2, padding + chartHeight + 18);
            context.fillStyle = dataset.valueColor || '#4c1d95';
            context.font = '11px Arial';
            const valueLabel = String(formatValue(value));
            context.fillText(valueLabel, x + barWidth / 2, y - 8);
          });
          context.textAlign = 'left';
        }
      }
      if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function (x, y, width, height, radius) {
          const r = Math.min(radius, width / 2, height / 2);
          this.beginPath();
          this.moveTo(x + r, y);
          this.lineTo(x + width - r, y);
          this.quadraticCurveTo(x + width, y, x + width, y + r);
          this.lineTo(x + width, y + height - r);
          this.quadraticCurveTo(x + width, y + height, x + width - r, y + height);
          this.lineTo(x + r, y + height);
          this.quadraticCurveTo(x, y + height, x, y + height - r);
          this.lineTo(x, y + r);
          this.quadraticCurveTo(x, y, x + r, y);
          this.closePath();
          return this;
        };
      }
    </script>
    <script>
      class jsPDF {
        constructor() {
          this.lines = [];
          this.fontSize = 12;
        }
        setFontSize(size) {
          this.fontSize = Number(size) || 12;
        }
        text(content, x, y) {
          const safeContent = String(content)
            .replace(/\\/g, '\\\\')
            .replace(/\(/g, '\\(')
            .replace(/\)/g, '\\)');
          this.lines.push({ x, y, text: safeContent, size: this.fontSize });
        }
        save(filename = 'document.pdf') {
          const textContent = this.lines
            .map((entry) => `BT /F1 ${entry.size} Tf ${entry.x} ${792 - entry.y} Td (${entry.text}) Tj ET`)
            .join('\n');
          const streamLength = textContent.length;
          const objects = [
            '1 0 obj << /Type /Catalog /Pages 2 0 R >> endobj',
            '2 0 obj << /Type /Pages /Kids [3 0 R] /Count 1 >> endobj',
            '3 0 obj << /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Resources << /Font << /F1 4 0 R >> >> /Contents 5 0 R >> endobj',
            '4 0 obj << /Type /Font /Subtype /Type1 /BaseFont /Helvetica >> endobj',
            `5 0 obj << /Length ${streamLength} >> stream\n${textContent}\nendstream endobj`,
          ];
          let pdf = '%PDF-1.3\n';
          let offset = pdf.length;
          const xrefEntries = ['0000000000 65535 f '];
          objects.forEach((object) => {
            const padded = String(offset).padStart(10, '0');
            xrefEntries.push(`${padded} 00000 n `);
            pdf += object + '\n';
            offset = pdf.length;
          });
          const xrefStart = offset;
          const xrefTable = `xref\n0 ${objects.length + 1}\n${xrefEntries.join('\n')}\n`;
          pdf += xrefTable;
          pdf += `trailer << /Size ${objects.length + 1} /Root 1 0 R >>\n`;
          pdf += `startxref\n${xrefStart}\n%%EOF`;
          const blob = new Blob([pdf], { type: 'application/pdf' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          setTimeout(() => {
            URL.revokeObjectURL(link.href);
            document.body.removeChild(link);
          }, 0);
        }
      }
    </script>
    <script>
      const STORAGE_KEYS = {
        license: 'zb_license',
        credentials: 'zb_credentials',
        pin: 'zb_pin',
        loginAttempts: 'zb_login_attempts',
        bookings: 'zb_bookings',
        invoices: 'zb_invoices',
        payments: 'zb_payments',
        settings: 'zb_settings',
        activity: 'zb_activity',
      };
      const LICENSE_CODE = 'ZANTRA-2025';
      const LICENSE_DURATION_MONTHS = 12;
      const state = {
        user: null,
        bookings: [],
        invoices: [],
        payments: [],
        settings: {
          businessName: 'Zantra Collective',
          businessEmail: 'hello@zantra.studio',
          businessPhone: '+1 (555) 010-2025',
          businessAddress: '123 Indigo Street, Austin, TX',
          brandColor: '#7c3aed',
        },
        revenueChart: null,
        bookingsChart: null,
      };

      const sanitizeInput = (value) => {
        if (typeof value !== 'string') return '';
        return value
          .replace(/[\u0000-\u001F\u007F]/g, '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;')
          .trim();
      };

      const showToast = (message, type = 'success') => {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${message}</span><button aria-label="Dismiss">Ã—</button>`;
        const dismiss = () => {
          toast.classList.add('hidden');
          setTimeout(() => toast.remove(), 200);
        };
        toast.querySelector('button').addEventListener('click', dismiss);
        container.appendChild(toast);
        setTimeout(dismiss, 4500);
      };

      const hashValue = async (value) => {
        const encoder = new TextEncoder();
        const data = encoder.encode(value);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash))
          .map((b) => b.toString(16).padStart(2, '0'))
          .join('');
      };

      const loadJson = (key, fallback) => {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return fallback;
          return JSON.parse(raw);
        } catch (error) {
          console.error('Failed to parse storage key', key, error);
          return fallback;
        }
      };

      const saveJson = (key, value) => {
        localStorage.setItem(key, JSON.stringify(value));
      };

      const checkLicense = () => {
        const record = loadJson(STORAGE_KEYS.license, null);
        if (!record) return false;
        return !isLicenseExpired(record.activatedAt);
      };

      const isLicenseExpired = (activatedAt) => {
        if (!activatedAt) return true;
        const activatedDate = new Date(activatedAt);
        if (Number.isNaN(activatedDate.getTime())) return true;
        const expiry = new Date(activatedDate);
        expiry.setMonth(expiry.getMonth() + LICENSE_DURATION_MONTHS);
        return new Date() > expiry;
      };

      const activateLicense = (code) => {
        if (code !== LICENSE_CODE) {
          return false;
        }
        saveJson(STORAGE_KEYS.license, { activatedAt: new Date().toISOString() });
        return true;
      };

      const getCredentials = () => loadJson(STORAGE_KEYS.credentials, null);
      const getPin = () => loadJson(STORAGE_KEYS.pin, null);

      const createUser = async (username, password) => {
        const cleanUsername = sanitizeInput(username);
        const cleanPassword = password.trim();
        if (cleanUsername.length < 3 || cleanPassword.length < 8) {
          throw new Error('Username or password does not meet requirements.');
        }
        const passwordHash = await hashValue(cleanPassword);
        const credentials = {
          username: cleanUsername,
          passwordHash,
          updatedAt: new Date().toISOString(),
        };
        saveJson(STORAGE_KEYS.credentials, credentials);
        recordActivity(`Account for ${cleanUsername} created.`);
        return credentials;
      };

      const loginUser = async (username, password) => {
        const attempts = loadJson(STORAGE_KEYS.loginAttempts, { count: 0, lockedUntil: 0 });
        const now = Date.now();
        if (attempts.lockedUntil && now < attempts.lockedUntil) {
          const seconds = Math.ceil((attempts.lockedUntil - now) / 1000);
          throw new Error(`Login locked. Try again in ${seconds} seconds.`);
        }
        const credentials = getCredentials();
        if (!credentials) {
          throw new Error('Account not set up.');
        }
        const hashedPassword = await hashValue(password.trim());
        if (credentials.username === sanitizeInput(username) && credentials.passwordHash === hashedPassword) {
          saveJson(STORAGE_KEYS.loginAttempts, { count: 0, lockedUntil: 0 });
          recordActivity(`User ${credentials.username} signed in.`);
          return true;
        }
        attempts.count += 1;
        if (attempts.count >= 5) {
          attempts.lockedUntil = now + 5 * 60 * 1000;
          attempts.count = 0;
          showToast('Too many attempts. Locked for 5 minutes.', 'error');
        }
        saveJson(STORAGE_KEYS.loginAttempts, attempts);
        throw new Error('Invalid username or password.');
      };

      const updateUser = async (username, password) => {
        const credentials = await createUser(username, password);
        showToast('Credentials updated successfully.');
        recordActivity('Account credentials updated.');
        return credentials;
      };

      const setPin = async (pin) => {
        const cleaned = pin.replace(/\D/g, '');
        if (cleaned.length !== 4) {
          throw new Error('PIN must be exactly 4 digits.');
        }
        const pinHash = await hashValue(cleaned);
        saveJson(STORAGE_KEYS.pin, { pinHash, updatedAt: new Date().toISOString() });
        recordActivity('Quick PIN configured.');
        return true;
      };

      const verifyPin = async (pin) => {
        const record = getPin();
        if (!record) {
          throw new Error('PIN not configured.');
        }
        const pinHash = await hashValue(pin.replace(/\D/g, ''));
        return record.pinHash === pinHash;
      };

      const updatePin = async (pin) => {
        await setPin(pin);
        showToast('PIN updated successfully.');
        recordActivity('Quick PIN updated.');
      };

      const recordActivity = (message) => {
        const activity = loadJson(STORAGE_KEYS.activity, []);
        activity.unshift({ message, timestamp: new Date().toISOString() });
        saveJson(STORAGE_KEYS.activity, activity.slice(0, 40));
      };

      const exportData = () => {
        const payload = {
          license: loadJson(STORAGE_KEYS.license, null),
          credentials: loadJson(STORAGE_KEYS.credentials, null),
          pin: loadJson(STORAGE_KEYS.pin, null),
          bookings: loadJson(STORAGE_KEYS.bookings, []),
          invoices: loadJson(STORAGE_KEYS.invoices, []),
          payments: loadJson(STORAGE_KEYS.payments, []),
          settings: loadJson(STORAGE_KEYS.settings, state.settings),
          activity: loadJson(STORAGE_KEYS.activity, []),
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'zantra-bookings-backup.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showToast('Data exported successfully.');
      };

      const importData = (json) => {
        if (!json || typeof json !== 'object') {
          throw new Error('Invalid JSON structure.');
        }
        const requiredKeys = [
          'license',
          'credentials',
          'pin',
          'bookings',
          'invoices',
          'payments',
          'settings',
          'activity',
        ];
        requiredKeys.forEach((key) => {
          if (!(key in json)) {
            throw new Error(`Missing key: ${key}`);
          }
        });
        saveJson(STORAGE_KEYS.license, json.license);
        saveJson(STORAGE_KEYS.credentials, json.credentials);
        saveJson(STORAGE_KEYS.pin, json.pin);
        saveJson(STORAGE_KEYS.bookings, Array.isArray(json.bookings) ? json.bookings : []);
        saveJson(STORAGE_KEYS.invoices, Array.isArray(json.invoices) ? json.invoices : []);
        saveJson(STORAGE_KEYS.payments, Array.isArray(json.payments) ? json.payments : []);
        saveJson(STORAGE_KEYS.settings, json.settings || state.settings);
        saveJson(STORAGE_KEYS.activity, Array.isArray(json.activity) ? json.activity : []);
        showToast('Backup imported. Reloading...');
        setTimeout(() => window.location.reload(), 1200);
      };
      const hideAllModals = () => {
        ['licenseModal', 'accountSetupModal', 'pinSetupModal', 'loginModal'].forEach((id) => {
          document.getElementById(id).classList.add('hidden');
        });
      };

      const showModal = (id) => {
        document.getElementById(id).classList.remove('hidden');
      };

      const loadAppState = () => {
        state.bookings = loadJson(STORAGE_KEYS.bookings, []);
        state.invoices = loadJson(STORAGE_KEYS.invoices, []);
        state.payments = loadJson(STORAGE_KEYS.payments, []);
        state.settings = Object.assign({}, state.settings, loadJson(STORAGE_KEYS.settings, {}));
      };

      const saveBookings = () => saveJson(STORAGE_KEYS.bookings, state.bookings);
      const saveInvoices = () => saveJson(STORAGE_KEYS.invoices, state.invoices);
      const savePayments = () => saveJson(STORAGE_KEYS.payments, state.payments);
      const saveSettings = () => saveJson(STORAGE_KEYS.settings, state.settings);

      const createId = () => (crypto.randomUUID ? crypto.randomUUID() : `id-${Date.now()}-${Math.random()}`);

      const renderBookings = () => {
        const tbody = document.getElementById('bookingTableBody');
        tbody.innerHTML = '';
        const bookings = state.bookings
          .slice()
          .sort((a, b) => new Date(a.date) - new Date(b.date));
        if (!bookings.length) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML =
            '<td colspan="5"><div class="empty-state-card" data-icon="ðŸ—‚">No bookings scheduled yet.</div></td>';
          tbody.appendChild(emptyRow);
        } else {
          bookings.forEach((booking) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${booking.date}</td>
              <td>${booking.time}</td>
              <td>${booking.client}</td>
              <td>
                <span class="flex items-center">
                  <span class="status-dot ${booking.status}"></span>
                  ${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}
                </span>
              </td>
              <td class="text-right">
                <div class="action-bar compact justify-end">
                  <button class="btn btn-outline" data-action="edit" data-id="${booking.id}">Edit</button>
                  <button class="btn btn-danger" data-action="delete" data-id="${booking.id}">Delete</button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        document.getElementById('bookingCountLabel').textContent = `${state.bookings.length} Records`;
      };

      const renderInvoices = () => {
        const list = document.getElementById('invoiceList');
        list.innerHTML = '';
        const invoices = state.invoices
          .slice()
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        if (!invoices.length) {
          const empty = document.createElement('div');
          empty.className = 'empty-state-card';
          empty.setAttribute('data-icon', 'ðŸ“„');
          empty.textContent = 'No invoices created yet.';
          list.appendChild(empty);
          document.getElementById('invoiceCountLabel').textContent = '0 Invoices';
          return;
        }
        invoices.forEach((invoice) => {
          const payments = state.payments.filter((payment) => payment.invoiceId === invoice.id);
          const totalPaid = payments.reduce((sum, payment) => sum + Number(payment.amount || 0), 0);
          const balance = Math.max(0, Number(invoice.amount || 0) - totalPaid);
          const wrapper = document.createElement('div');
          wrapper.className = 'list-item';
          wrapper.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold">${invoice.client}</h3>
                <p class="text-sm text-muted">Due ${invoice.dueDate}</p>
              </div>
              <div class="text-right">
                <p class="text-lg font-semibold">$${Number(invoice.amount).toFixed(2)}</p>
                <span class="badge ${invoice.status === 'paid' ? 'badge-success' : invoice.status === 'overdue' ? 'badge-danger' : 'badge-info'}">
                  ${invoice.status.toUpperCase()}
                </span>
              </div>
            </div>
            <p class="text-sm text-muted">Balance: $${balance.toFixed(2)} Â· Total Paid: $${totalPaid.toFixed(2)}</p>
            ${invoice.notes ? `<p class="text-sm">${invoice.notes}</p>` : ''}
            <div class="action-bar mt-2">
              <button class="btn btn-outline" data-action="edit" data-id="${invoice.id}">Edit</button>
              <button class="btn btn-primary" data-action="payment" data-id="${invoice.id}">Add Payment</button>
              <button class="btn btn-secondary" data-action="pdf" data-id="${invoice.id}">Generate PDF</button>
              <button class="btn btn-danger" data-action="delete" data-id="${invoice.id}">Delete</button>
            </div>
            <div class="mt-2">
              <p class="text-sm text-muted font-medium">Payments</p>
              <ul class="list mt-2">
                ${
                  payments.length
                    ? payments
                        .map(
                          (payment) => `
                            <li class="nested-card" data-payment-id="${payment.id}">
                              <div class="flex items-center justify-between">
                                <div>
                                  <p class="text-sm font-medium">${payment.method} Â· ${payment.date}</p>
                                  <p class="text-xs text-muted">Recorded ${new Date(payment.createdAt).toLocaleString()}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                  <span class="badge badge-success">$${Number(payment.amount).toFixed(2)}</span>
                                  <div class="action-bar compact">
                                    <button class="btn btn-outline" data-action="edit-payment" data-id="${payment.id}">Edit</button>
                                    <button class="btn btn-danger" data-action="delete-payment" data-id="${payment.id}">Delete</button>
                                  </div>
                                </div>
                              </div>
                            </li>
                          `
                        )
                        .join('')
                    : '<li class="empty-state-card" data-icon="ðŸ’³">No payments recorded yet.</li>'
                }
              </ul>
            </div>
          `;
          list.appendChild(wrapper);
        });
        document.getElementById('invoiceCountLabel').textContent = `${state.invoices.length} Invoices`;
      };

      const renderActivity = () => {
        const container = document.getElementById('activityTimeline');
        const entries = loadJson(STORAGE_KEYS.activity, []);
        container.innerHTML = '';
        if (!entries.length) {
          const empty = document.createElement('div');
          empty.className = 'empty-state-card';
          empty.setAttribute('data-icon', 'ðŸ—‚');
          empty.textContent = 'No activity yet.';
          container.appendChild(empty);
          return;
        }
        entries.slice(0, 8).forEach((entry) => {
          const item = document.createElement('div');
          item.className = 'timeline-item';
          item.setAttribute('role', 'listitem');
          const card = document.createElement('div');
          card.className = 'timeline-card';
          const time = new Date(entry.timestamp).toLocaleString();
          card.innerHTML = `<p class="font-medium">${entry.message}</p><p class="text-xs text-muted">${time}</p>`;
          item.appendChild(card);
          container.appendChild(item);
        });
      };

      const renderAuditTrail = () => {
        const container = document.getElementById('auditTrailList');
        if (!container) return;
        container.innerHTML = '';
        const entries = loadJson(STORAGE_KEYS.activity, []);
        if (!entries.length) {
          const empty = document.createElement('div');
          empty.className = 'empty-state-card';
          empty.setAttribute('data-icon', 'ðŸ“„');
          empty.textContent = 'No audit entries logged yet.';
          container.appendChild(empty);
          return;
        }
        entries.slice(0, 12).forEach((entry) => {
          const item = document.createElement('div');
          item.className = 'list-item';
          item.setAttribute('role', 'listitem');
          item.innerHTML = `
            <div class="flex items-center justify-between">
              <p class="font-medium">${entry.message}</p>
              <span class="text-xs text-muted">${new Date(entry.timestamp).toLocaleString()}</span>
            </div>
          `;
          container.appendChild(item);
        });
      };

      const sumPaymentsForMonth = (year, month) => {
        return state.payments
          .filter((payment) => {
            const d = new Date(payment.date);
            return d.getFullYear() === year && d.getMonth() === month;
          })
          .reduce((sum, payment) => sum + Number(payment.amount || 0), 0);
      };

      const countBookingsForMonth = (year, month) => {
        return state.bookings
          .filter((booking) => {
            if (!booking.date) return false;
            const d = new Date(booking.date);
            if (Number.isNaN(d.getTime())) return false;
            if (booking.status === 'cancelled') return false;
            return d.getFullYear() === year && d.getMonth() === month;
          })
          .length;
      };

      const renderMetrics = () => {
        const today = new Date();
        const upcoming = state.bookings.filter((booking) => {
          const date = new Date(`${booking.date}T${booking.time || '00:00'}`);
          return date >= new Date(today.toDateString()) && booking.status !== 'cancelled';
        }).length;
        const pendingInvoices = state.invoices.filter((invoice) => invoice.status !== 'paid').length;
        const collected = state.payments
          .filter((payment) => {
            const date = new Date(payment.date);
            return date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
          })
          .reduce((sum, payment) => sum + Number(payment.amount || 0), 0);
        const paymentDurations = state.payments
          .map((payment) => {
            const invoice = state.invoices.find((inv) => inv.id === payment.invoiceId);
            if (!invoice) return null;
            const invoiceDate = new Date(invoice.createdAt || invoice.dueDate || payment.date);
            const paymentDate = new Date(payment.date);
            const diff = Math.max(0, paymentDate - invoiceDate);
            return diff / (1000 * 60 * 60 * 24);
          })
          .filter((value) => value !== null);
        const averagePayment = paymentDurations.length
          ? (paymentDurations.reduce((sum, value) => sum + value, 0) / paymentDurations.length).toFixed(1)
          : '0';
        document.getElementById('metricUpcoming').textContent = upcoming;
        document.getElementById('metricPendingInvoices').textContent = pendingInvoices;
        document.getElementById('metricCollected').textContent = `$${collected.toFixed(2)}`;
        document.getElementById('metricAvgPayment').textContent = `${averagePayment} days`;
      };

      const renderRevenueChart = () => {
        const canvas = document.getElementById('revenueChart');
        const emptyState = document.getElementById('revenueEmptyState');
        if (!canvas || !emptyState) return;
        const hasPayments = state.payments.length > 0;
        const now = new Date();
        const labels = [];
        const dataPoints = [];
        for (let i = 11; i >= 0; i -= 1) {
          const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
          labels.push(date.toLocaleDateString(undefined, { month: 'short' }));
          dataPoints.push(sumPaymentsForMonth(date.getFullYear(), date.getMonth()));
        }
        const hasRevenue = dataPoints.some((value) => value > 0);
        if (!hasPayments || !hasRevenue) {
          emptyState.classList.remove('hidden');
          canvas.classList.add('hidden');
          canvas.setAttribute('aria-hidden', 'true');
          if (state.revenueChart) {
            state.revenueChart.destroy();
            state.revenueChart = null;
          }
          return;
        }
        emptyState.classList.add('hidden');
        canvas.classList.remove('hidden');
        canvas.removeAttribute('aria-hidden');
        const ctx = canvas.getContext('2d');
        const dataset = {
          data: dataPoints,
          formatValue: (value) => `$${value.toFixed(2)}`,
          formatAxis: (value) => `$${value.toFixed(0)}`,
          gradientStops: [
            { offset: 0, color: 'rgba(76,29,149,0.9)' },
            { offset: 1, color: 'rgba(124,58,237,0.6)' },
          ],
          valueColor: '#4c1d95',
        };
        if (state.revenueChart) {
          state.revenueChart.update({ data: { labels, datasets: [dataset] } });
        } else {
          state.revenueChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [dataset] },
            options: {},
          });
        }
      };

      const renderBookingsChart = () => {
        const canvas = document.getElementById('bookingsChart');
        const emptyState = document.getElementById('bookingsEmptyState');
        if (!canvas || !emptyState) return;
        const now = new Date();
        const labels = [];
        const dataPoints = [];
        for (let i = 11; i >= 0; i -= 1) {
          const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
          labels.push(date.toLocaleDateString(undefined, { month: 'short' }));
          dataPoints.push(countBookingsForMonth(date.getFullYear(), date.getMonth()));
        }
        const hasBookings = dataPoints.some((value) => value > 0);
        if (!hasBookings) {
          emptyState.classList.remove('hidden');
          canvas.classList.add('hidden');
          canvas.setAttribute('aria-hidden', 'true');
          if (state.bookingsChart) {
            state.bookingsChart.destroy();
            state.bookingsChart = null;
          }
          return;
        }
        emptyState.classList.add('hidden');
        canvas.classList.remove('hidden');
        canvas.removeAttribute('aria-hidden');
        const ctx = canvas.getContext('2d');
        const dataset = {
          data: dataPoints,
          formatValue: (value) => `${value}`,
          formatAxis: (value) => `${Math.round(value)}`,
          gradientStops: [
            { offset: 0, color: 'rgba(124,58,237,0.85)' },
            { offset: 1, color: 'rgba(167,139,250,0.55)' },
          ],
          valueColor: '#4c1d95',
        };
        if (state.bookingsChart) {
          state.bookingsChart.update({ data: { labels, datasets: [dataset] } });
        } else {
          state.bookingsChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [dataset] },
            options: {},
          });
        }
      };

      const renderOutstandingSummary = () => {
        const countEl = document.getElementById('outstandingCount');
        const amountEl = document.getElementById('outstandingAmount');
        if (!countEl || !amountEl) return;
        const outstandingInvoices = state.invoices.filter((invoice) => invoice.status !== 'paid');
        const outstandingAmount = outstandingInvoices.reduce((sum, invoice) => {
          const payments = state.payments.filter((payment) => payment.invoiceId === invoice.id);
          const paid = payments.reduce((acc, payment) => acc + Number(payment.amount || 0), 0);
          const remaining = Math.max(0, Number(invoice.amount || 0) - paid);
          return sum + remaining;
        }, 0);
        countEl.textContent = outstandingInvoices.length;
        amountEl.textContent = `$${outstandingAmount.toFixed(2)}`;
      };

      const applyBranding = () => {
        const { businessName, businessEmail, businessPhone, businessAddress, brandColor } = state.settings;
        document.getElementById('businessName').value = businessName || '';
        document.getElementById('businessEmail').value = businessEmail || '';
        document.getElementById('businessPhone').value = businessPhone || '';
        document.getElementById('businessAddress').value = businessAddress || '';
        document.getElementById('brandColor').value = brandColor || '#7c3aed';
        document.documentElement.style.setProperty('--brand-accent', brandColor || '#7c3aed');
        document.getElementById('businessTagline').textContent = businessName
          ? `${businessName} Â· ${businessEmail || 'Bookings Console'}`
          : 'Manage bookings, invoices, and insights offline-first.';
      };

      const setActiveUser = (username) => {
        state.user = username;
        const activeUserLabel = document.getElementById('activeUserLabel');
        const avatar = document.getElementById('userAvatar');
        if (username) {
          activeUserLabel.textContent = `Signed in as ${username}`;
          const initials = username
            .split(' ')
            .map((part) => part.charAt(0).toUpperCase())
            .join('')
            .slice(0, 2);
          avatar.textContent = initials || 'ZB';
        } else {
          activeUserLabel.textContent = 'Offline Mode';
          avatar.textContent = 'ZB';
        }
      };
      const refreshDashboard = () => {
        renderBookings();
        renderInvoices();
        renderMetrics();
        renderRevenueChart();
        renderBookingsChart();
        renderOutstandingSummary();
        renderActivity();
        renderAuditTrail();
      };

      const completeLogin = (username) => {
        hideAllModals();
        loadAppState();
        setActiveUser(username);
        applyBranding();
        refreshDashboard();
        showToast('Welcome back to Zantra Bookings.');
      };

      const startAuthFlow = () => {
        hideAllModals();
        const credentials = getCredentials();
        const pinRecord = getPin();
        const pinTab = document.getElementById('pinTab');
        const pinLoginForm = document.getElementById('pinLoginForm');
        const passwordTab = document.getElementById('passwordTab');
        pinLoginForm.classList.add('hidden');
        passwordTab.classList.add('active');
        passwordTab.setAttribute('aria-selected', 'true');
        pinTab.classList.remove('active');
        pinTab.setAttribute('aria-selected', 'false');
        document.getElementById('loginForm').classList.remove('hidden');
        if (pinRecord) {
          pinTab.removeAttribute('aria-disabled');
        } else {
          pinTab.setAttribute('aria-disabled', 'true');
        }
        if (!credentials) {
          showModal('accountSetupModal');
        } else {
          document.getElementById('loginUsername').value = credentials.username;
          showModal('loginModal');
        }
      };

      const updateLicenseInfo = () => {
        const info = document.getElementById('licenseInfo');
        const record = loadJson(STORAGE_KEYS.license, null);
        if (!record) {
          info.textContent = 'No activation detected. Enter your unlock code to get started.';
          return;
        }
        const activatedAt = new Date(record.activatedAt);
        const expiry = new Date(activatedAt);
        expiry.setMonth(expiry.getMonth() + LICENSE_DURATION_MONTHS);
        const expired = isLicenseExpired(record.activatedAt);
        info.textContent = expired
          ? `License expired on ${expiry.toDateString()}. Enter a valid unlock code.`
          : `License active until ${expiry.toDateString()}.`;
      };

      const handlePaymentDialog = (invoice, existingPayment = null) => {
        const defaultAmount = existingPayment ? existingPayment.amount : invoice.amount;
        const amountInput = prompt('Payment amount', defaultAmount || '');
        if (amountInput === null) return null;
        const amount = Number(amountInput);
        if (Number.isNaN(amount) || amount < 0) {
          showToast('Invalid amount.', 'error');
          return null;
        }
        const defaultDate = existingPayment ? existingPayment.date : new Date().toISOString().slice(0, 10);
        const dateInput = prompt('Payment date (YYYY-MM-DD)', defaultDate);
        if (dateInput === null) return null;
        if (!/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
          showToast('Invalid date format.', 'error');
          return null;
        }
        const defaultMethod = existingPayment ? existingPayment.method : 'Bank Transfer';
        const methodInput = prompt('Payment method', defaultMethod);
        if (methodInput === null) return null;
        const method = sanitizeInput(methodInput);
        if (!method) {
          showToast('Payment method required.', 'error');
          return null;
        }
        return {
          amount,
          date: dateInput,
          method,
        };
      };

      document.addEventListener('DOMContentLoaded', () => {
        updateLicenseInfo();

        document.getElementById('licenseForm').addEventListener('submit', (event) => {
          event.preventDefault();
          const code = document.getElementById('licenseCode').value.trim();
          if (activateLicense(code)) {
            showToast('License activated successfully.');
            updateLicenseInfo();
            startAuthFlow();
          } else {
            showToast('Invalid activation code.', 'error');
          }
        });

        document.getElementById('accountSetupForm').addEventListener('submit', async (event) => {
          event.preventDefault();
          const username = document.getElementById('setupUsername').value;
          const password = document.getElementById('setupPassword').value;
          const confirm = document.getElementById('setupPasswordConfirm').value;
          if (password !== confirm) {
            showToast('Passwords do not match.', 'error');
            return;
          }
          try {
            const credentials = await createUser(username, password);
            showToast('Account created. Secure a quick PIN next.');
            document.getElementById('accountSetupModal').classList.add('hidden');
            document.getElementById('pinSetupModal').classList.remove('hidden');
            document.getElementById('pinSetupForm').dataset.username = credentials.username;
          } catch (error) {
            showToast(error.message, 'error');
          }
        });

        document.getElementById('pinSetupForm').addEventListener('submit', async (event) => {
          event.preventDefault();
          const pin = document.getElementById('setupPin').value;
          const username = event.currentTarget.dataset.username;
          try {
            await setPin(pin);
            showToast('PIN saved successfully.');
            event.currentTarget.reset();
            delete event.currentTarget.dataset.username;
            completeLogin(username || (getCredentials() && getCredentials().username));
          } catch (error) {
            showToast(error.message, 'error');
          }
        });

        document.getElementById('skipPinButton').addEventListener('click', (event) => {
          const username = document.getElementById('pinSetupForm').dataset.username;
          delete document.getElementById('pinSetupForm').dataset.username;
          document.getElementById('pinSetupModal').classList.add('hidden');
          completeLogin(username || (getCredentials() && getCredentials().username));
        });

        document.getElementById('passwordTab').addEventListener('click', () => {
          document.getElementById('passwordTab').classList.add('active');
          document.getElementById('passwordTab').setAttribute('aria-selected', 'true');
          document.getElementById('pinTab').classList.remove('active');
          document.getElementById('pinTab').setAttribute('aria-selected', 'false');
          document.getElementById('loginForm').classList.remove('hidden');
          document.getElementById('pinLoginForm').classList.add('hidden');
        });

        document.getElementById('pinTab').addEventListener('click', () => {
          if (document.getElementById('pinTab').hasAttribute('aria-disabled')) {
            showToast('Set a PIN in Settings to enable quick login.', 'error');
            return;
          }
          document.getElementById('pinTab').classList.add('active');
          document.getElementById('pinTab').setAttribute('aria-selected', 'true');
          document.getElementById('passwordTab').classList.remove('active');
          document.getElementById('passwordTab').setAttribute('aria-selected', 'false');
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('pinLoginForm').classList.remove('hidden');
        });

        document.getElementById('loginForm').addEventListener('submit', async (event) => {
          event.preventDefault();
          const username = document.getElementById('loginUsername').value;
          const password = document.getElementById('loginPassword').value;
          try {
            await loginUser(username, password);
            completeLogin(username);
            event.currentTarget.reset();
          } catch (error) {
            showToast(error.message, 'error');
          }
        });

        document.getElementById('pinLoginForm').addEventListener('submit', async (event) => {
          event.preventDefault();
          const pin = document.getElementById('loginPin').value;
          try {
            if (await verifyPin(pin)) {
              const credentials = getCredentials();
              completeLogin(credentials ? credentials.username : '');
              event.currentTarget.reset();
            } else {
              showToast('Incorrect PIN.', 'error');
            }
          } catch (error) {
            showToast(error.message, 'error');
          }
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
          setActiveUser(null);
          showToast('Logged out. Sign in to continue.', 'success');
          startAuthFlow();
        });

        document.querySelectorAll('nav button[data-tab]').forEach((button) => {
          button.addEventListener('click', () => {
            document.querySelectorAll('nav button[data-tab]').forEach((btn) => {
              btn.classList.remove('active');
              btn.setAttribute('aria-selected', 'false');
            });
            button.classList.add('active');
            button.setAttribute('aria-selected', 'true');
            const tab = button.getAttribute('data-tab');
            document.querySelectorAll('.tab-content').forEach((section) => {
              section.classList.remove('active');
            });
            document.getElementById(tab).classList.add('active');
          });
        });

        const bookingForm = document.getElementById('bookingForm');
        bookingForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const booking = {
            date: bookingForm.bookingDate.value,
            time: bookingForm.bookingTime.value,
            client: sanitizeInput(bookingForm.bookingClient.value),
            status: bookingForm.bookingStatus.value,
          };
          if (!booking.date || !booking.time || !booking.client) {
            showToast('All booking fields are required.', 'error');
            return;
          }
          const editId = bookingForm.dataset.editId;
          if (editId) {
            const index = state.bookings.findIndex((b) => b.id === editId);
            if (index !== -1) {
              state.bookings[index] = Object.assign({}, state.bookings[index], booking);
              recordActivity(`Booking updated for ${booking.client}.`);
            }
            delete bookingForm.dataset.editId;
          } else {
            state.bookings.push({ id: createId(), createdAt: new Date().toISOString(), ...booking });
            recordActivity(`Booking added for ${booking.client}.`);
          }
          saveBookings();
          refreshDashboard();
          bookingForm.reset();
          showToast('Booking saved.');
        });

        document.getElementById('bookingTableBody').addEventListener('click', (event) => {
          const button = event.target.closest('button[data-action]');
          if (!button) return;
          const { action, id } = button.dataset;
          if (action === 'delete') {
            if (confirm('Delete this booking?')) {
              state.bookings = state.bookings.filter((booking) => booking.id !== id);
              saveBookings();
              recordActivity('Booking removed.');
              refreshDashboard();
              showToast('Booking deleted.');
            }
          }
          if (action === 'edit') {
            const booking = state.bookings.find((item) => item.id === id);
            if (!booking) return;
            bookingForm.bookingDate.value = booking.date;
            bookingForm.bookingTime.value = booking.time;
            bookingForm.bookingClient.value = booking.client;
            bookingForm.bookingStatus.value = booking.status;
            bookingForm.dataset.editId = id;
            showToast('Editing booking. Save to apply changes.');
          }
        });

        const invoiceForm = document.getElementById('invoiceForm');
        invoiceForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const invoice = {
            client: sanitizeInput(invoiceForm.invoiceClient.value),
            amount: Number(invoiceForm.invoiceAmount.value || 0),
            dueDate: invoiceForm.invoiceDueDate.value,
            status: invoiceForm.invoiceStatus.value,
            notes: sanitizeInput(invoiceForm.invoiceNotes.value || ''),
          };
          if (!invoice.client || !invoice.dueDate || Number.isNaN(invoice.amount)) {
            showToast('Invoice requires client, amount, and due date.', 'error');
            return;
          }
          const editId = invoiceForm.invoiceId.value;
          if (editId) {
            const index = state.invoices.findIndex((item) => item.id === editId);
            if (index !== -1) {
              state.invoices[index] = Object.assign({}, state.invoices[index], invoice);
              recordActivity(`Invoice updated for ${invoice.client}.`);
            }
          } else {
            state.invoices.push({ id: createId(), createdAt: new Date().toISOString(), ...invoice });
            recordActivity(`Invoice created for ${invoice.client}.`);
          }
          saveInvoices();
          refreshDashboard();
          invoiceForm.reset();
          invoiceForm.invoiceId.value = '';
          showToast('Invoice saved.');
        });

        document.getElementById('invoiceReset').addEventListener('click', () => {
          invoiceForm.invoiceId.value = '';
          invoiceForm.reset();
        });

        document.getElementById('invoiceList').addEventListener('click', (event) => {
          const button = event.target.closest('button[data-action]');
          if (!button) return;
          const { action, id } = button.dataset;
          const invoice = state.invoices.find((item) => item.id === id);
          if (action === 'delete') {
            if (!confirm('Delete this invoice and related payments?')) return;
            state.invoices = state.invoices.filter((item) => item.id !== id);
            state.payments = state.payments.filter((payment) => payment.invoiceId !== id);
            saveInvoices();
            savePayments();
            recordActivity('Invoice removed.');
            refreshDashboard();
            showToast('Invoice deleted.');
            return;
          }
          if (!invoice) {
            showToast('Invoice not found.', 'error');
            return;
          }
          if (action === 'edit') {
            invoiceForm.invoiceClient.value = invoice.client;
            invoiceForm.invoiceAmount.value = invoice.amount;
            invoiceForm.invoiceDueDate.value = invoice.dueDate;
            invoiceForm.invoiceStatus.value = invoice.status;
            invoiceForm.invoiceNotes.value = invoice.notes || '';
            invoiceForm.invoiceId.value = invoice.id;
            showToast('Editing invoice. Save to update.');
          }
          if (action === 'payment') {
            const details = handlePaymentDialog(invoice);
            if (!details) return;
            const payment = {
              id: createId(),
              invoiceId: invoice.id,
              amount: details.amount,
              date: details.date,
              method: details.method,
              createdAt: new Date().toISOString(),
            };
            state.payments.push(payment);
            savePayments();
            recordActivity(`Payment recorded for ${invoice.client}.`);
            refreshDashboard();
            showToast('Payment added.');
          }
          if (action === 'pdf') {
            const doc = new jsPDF();
            const settings = state.settings;
            doc.setFontSize(18);
            doc.text(settings.businessName || 'Zantra Bookings', 40, 60);
            doc.setFontSize(12);
            doc.text(`Invoice for ${invoice.client}`, 40, 90);
            doc.text(`Amount: $${Number(invoice.amount).toFixed(2)}`, 40, 110);
            doc.text(`Due: ${invoice.dueDate}`, 40, 130);
            doc.text(`Status: ${invoice.status}`, 40, 150);
            doc.text('Payments:', 40, 180);
            const payments = state.payments.filter((payment) => payment.invoiceId === invoice.id);
            let y = 200;
            payments.forEach((payment) => {
              doc.text(
                `${payment.date} Â· $${Number(payment.amount).toFixed(2)} Â· ${payment.method}`,
                40,
                y
              );
              y += 20;
            });
            doc.text(settings.businessEmail || '', 40, y + 20);
            doc.save(`Invoice-${invoice.client}.pdf`);
            showToast('PDF invoice generated.');
          }
          if (action === 'edit-payment') {
            const payment = state.payments.find((item) => item.id === id);
            if (!payment) return;
            const details = handlePaymentDialog(invoice, payment);
            if (!details) return;
            payment.amount = details.amount;
            payment.date = details.date;
            payment.method = details.method;
            savePayments();
            recordActivity('Payment updated.');
            refreshDashboard();
            showToast('Payment updated.');
          }
          if (action === 'delete-payment') {
            if (!confirm('Delete this payment?')) return;
            state.payments = state.payments.filter((payment) => payment.id !== id);
            savePayments();
            recordActivity('Payment removed.');
            refreshDashboard();
            showToast('Payment deleted.');
          }
        });

        document.getElementById('brandingForm').addEventListener('submit', (event) => {
          event.preventDefault();
          state.settings.businessName = sanitizeInput(document.getElementById('businessName').value);
          state.settings.businessEmail = sanitizeInput(document.getElementById('businessEmail').value);
          state.settings.businessPhone = sanitizeInput(document.getElementById('businessPhone').value);
          state.settings.businessAddress = sanitizeInput(document.getElementById('businessAddress').value);
          state.settings.brandColor = document.getElementById('brandColor').value || '#7c3aed';
          saveSettings();
          applyBranding();
          showToast('Branding updated.');
        });

        document.getElementById('resetBranding').addEventListener('click', () => {
          state.settings = {
            businessName: 'Zantra Collective',
            businessEmail: 'hello@zantra.studio',
            businessPhone: '+1 (555) 010-2025',
            businessAddress: '123 Indigo Street, Austin, TX',
            brandColor: '#7c3aed',
          };
          saveSettings();
          applyBranding();
          showToast('Branding reset.');
        });

        document.getElementById('updateCredentialsForm').addEventListener('submit', async (event) => {
          event.preventDefault();
          const username = document.getElementById('updateUsername').value;
          const password = document.getElementById('updatePassword').value;
          const confirm = document.getElementById('updatePasswordConfirm').value;
          if (password !== confirm) {
            showToast('Passwords do not match.', 'error');
            return;
          }
          try {
            const credentials = await updateUser(username, password);
            setActiveUser(credentials.username);
            event.currentTarget.reset();
          } catch (error) {
            showToast(error.message, 'error');
          }
        });

        document.getElementById('updatePinForm').addEventListener('submit', async (event) => {
          event.preventDefault();
          const pin = document.getElementById('updatePin').value;
          try {
            await updatePin(pin);
            event.currentTarget.reset();
            document.getElementById('pinTab').removeAttribute('aria-disabled');
          } catch (error) {
            showToast(error.message, 'error');
          }
        });

        document.getElementById('clearCredentials').addEventListener('click', () => {
          if (!confirm('Clear license and credentials? You will need to re-activate.')) return;
          localStorage.removeItem(STORAGE_KEYS.license);
          localStorage.removeItem(STORAGE_KEYS.credentials);
          localStorage.removeItem(STORAGE_KEYS.pin);
          localStorage.removeItem(STORAGE_KEYS.loginAttempts);
          showToast('Credentials cleared. Reloading...');
          setTimeout(() => window.location.reload(), 1000);
        });

        document.getElementById('exportData').addEventListener('click', () => {
          try {
            exportData();
          } catch (error) {
            showToast('Export failed.', 'error');
          }
        });

        document.getElementById('importFile').addEventListener('change', (event) => {
          const file = event.target.files && event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const json = JSON.parse(reader.result);
              importData(json);
            } catch (error) {
              showToast('Import failed. Invalid JSON.', 'error');
            }
          };
          reader.readAsText(file);
        });

        if (!checkLicense()) {
          showModal('licenseModal');
        } else {
          startAuthFlow();
        }
      });
    </script>
  </body>
</html>
